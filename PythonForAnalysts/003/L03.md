# Модификация таблиц с Pandas. Лекция 9.

Краткая цель лекции:
+ Научиться создавать, изменять и удалять признаки
+ Изучить группировку данных и объединение таблиц
+ Познакомиться со встроенными визуализациями

На предыдущей лекции знакомились с анализом данных с помощью библиотеки Pandas. <br>
Она позволяет быстро считать статистики, фильтроваться по данным и сортировать их.

## Термины лекции 
__Признак__ (англ.feature) — это индивидуальное свойство или характеристика объекта.
__Агрегация__, или агрегирование — процесс объединения элементов в одно значение.

# План лекции 3
1.	[Работа с признаками](#работа-с-признаками)
    + [Создание признака](#создание-признака)
    + [Удаление признака](#удаление-признака)
    + [Изменение признака](#изменение-признака)
        + [.loc](#loc)
        + [.replace](#replace)
2.	[Методы агрегации](#методы-агрегации)
3.	[Методы объединения](#методы-объединения)
    + [Метод merge](#метод-merge)
    + [Метод join](#метод-join)
    + [Атрибут how](#атрибут-how)
4.	[Методы группировки](#методы-группировки)
    + [groupby](#groupby)
    + [pivot_table](#pivot_table)
    + [crosstab](#crosstab)
5. [Встроенные визуализации](#встроенные-визуализации)
6. [Рекомендуемая дополнительная литература или материалы](#рекомендуемая-дополнительная-литература-или-материалы)
7. [Работа на семинаре](#работа-на-семинаре)
8. [Работа на семинаре](/PythonForAnalysts/003/S03.ipynb)
9. [Дополнительные материалы lambda](/PythonForAnalysts/003/S03lambdas.ipynb)
10. [Домашняя работа](/PythonForAnalysts/003/HW03.ipynb)


В этом уроке продолжаем знакомиться с анализом данных с помощью библиотеки Pandas.

## Работа с признаками

__Признак__ (англ.feature) — это индивидуальное свойство или характеристика объекта.

__Признак__ - это любая характеристика в данных.<br>
Возраст всех наших клиентов - это признаке. <br> 
Их пол - это тоже признак.

## Создание признака

И начнем наше занятие с создания новых признаков. <br>
Создавать новые признаки можно очень большим количеством подходов, мы рассмотрим некоторые из них.<br>
Самый простой способ - заполнить новый признак одинаковыми числами:

# Модификация таблиц с Pandas. Лекция 9.
![](/PythonForAnalysts/Pictures/003_001.png)

Можно создать новый признак, основываясь на уже имеющихся. Для этого:
-	Берем признак через квадратные скобки (users[‘Age’])
-	Делаем любое преобразование (у нас это умножение на 365)
-	Присваиваем измененные данных в новый признак (users[‘Age (days)’] = )


![](/PythonForAnalysts/Pictures/003_002.png)

Или же можно пройтись по циклы, используя метод iterrows(), в этом случае мы итерируемся по строкам и получаем все значения одного объекта за раз:

![](/PythonForAnalysts/Pictures/003_003.png)

Можем проводить разные математические вычисления со значениями в признаке, к примеру:
1.	Сложение +
2.	Вычитание -
3.	Деление /
4.	Умножение *
5.	И так далее
А результат работы можем записать в заранее подготовленный массив:

![](/PythonForAnalysts/Pictures/003_004.png)

И затем добавить этот массив в датафрейм:

![](/PythonForAnalysts/Pictures/003_005.png)

Но одна проблема с перебором всех строк датафрейма в цикле - это очень долго. Поэтому можем пользоваться методом __apply__, который ускоряет обход всех строк. Для этого нужно реализовать функцию (или же пользоваться анонимными функциями) и передать её в метод __apply__:

![](/PythonForAnalysts/Pictures/003_006.png)

Если в вашем наборе данных очень много строк, то и выполнение apply может затянуться, в этом случае можно визуализировать процесс обхода датафрейма через библиотеку tqdm:

![](/PythonForAnalysts/Pictures/003_007.png)

[Содержание](#план-лекции-3)

<hr>

## Удаление признака

Чтобы удалить столбец из таблицы можем пользоваться методом drop():

![](/PythonForAnalysts/Pictures/003_008.png)

Но замечаем такую особенность, что признак всё равно на месте, он не удалился. Чтобы он на самом деле исчез нужно либо явно переопределить датафрейм:

![](/PythonForAnalysts/Pictures/003_009.png)

Либо указать атрибут __inplace=True:__

![](/PythonForAnalysts/Pictures/003_010.png)

При этом можно удалять не только один признак за раз, а целый список признаков:

![](/PythonForAnalysts/Pictures/003_011.png)

[Содержание](#план-лекции-3)

<hr>

## Изменение признака

[Содержание](#план-лекции-3)

<hr>

### .loc

Чтобы изменить существующий признак пользуйтесь фильтрацией с помощью .loc, чтобы выделить нужные строки:

![](/PythonForAnalysts/Pictures/003_012.png)

Затем указываете, какую колонку хотите изменить:

![](/PythonForAnalysts/Pictures/003_013.png)

И на какое значение:

![](/PythonForAnalysts/Pictures/003_014.png)

Если будете менять существующие признаки без .loc, то будете наблюдать подобное предупреждение и признак не будет меняться. Всё из-за того, что меняются значения не в исходном датафрейме, а в его копии:

![](/PythonForAnalysts/Pictures/003_015.png)

[Содержание](#план-лекции-3)

<hr>

### .replace

Будем работать с pd.Series. pd.Series представляет из себя объект, похожий на одномерный массив, но отличительной чертой является наличие индексов. Индекс находится слева, а сам элемент справа.
Метод replace() можно вызвать у этого объекта. Вызвать метод значит обратиться к нему через точку у pandas серии (users[‘Gender’].replace()).
Затем в этот метод можем передать словарь, состоящий из старого значения и нового. При этом, чтобы изменения вступили в силу, нужно либо переопределить признак, либо воспользоваться атрибутом inplace=True:

![](/PythonForAnalysts/Pictures/003_016.png)

[Содержание](#план-лекции-3)

<hr>

## Методы агрегации

Агрегация, или агрегирование — процесс объединения элементов в одно значение.

Агрегация данных нужна для того, чтобы подсчитать статистики в таблицы, например, для того, чтобы узнать средний возраст клиентов или же их максимальный чек.
Дальше обсудим, как можно агрегировать значения в таблицах.

Первый способ - вызвать метод agg() у pd.Series и передать в него список желаемых агрегаций:

![](/PythonForAnalysts/Pictures/003_017.png)

Второй способ - вызвать метод agg() у датафрейма. Это значит, что после переменной с датафреймом нужно через точку указать название метода .replace. В вызов этого метода можно передать словарь, где
-	 ключ - название признака
-	значение - список желаемых агрегаций


![](/PythonForAnalysts/Pictures/003_018.png)

И третий способ - вызвать метод agg() у датафрейма и передать аргументы (которые будут названиями строк) со значениями кортежа: 

![](/PythonForAnalysts/Pictures/003_019.png)

[Содержание](#план-лекции-3)

<hr>

## Методы объединения

[Содержание](#план-лекции-3)

<hr>

### Метод merge

С помощью метода merge() можно объединить две таблицы по столбцам. У первого датафрейма вызываем метод merge() и в него передаем:
-	второй датафрейм
-	столбец с левого датафрейма (он же первый), по которому нужно объединение (аргумент left_on)
-	столбец с правого датафрейма (он же второй), по которому нужно объединение (аргумент right_on) 

![](/PythonForAnalysts/Pictures/003_020.png)

[Содержание](#план-лекции-3)

<hr>

### Метод join

Данный метод объединяет две таблицы по индексам, поэтому для успешного объединения нужно указать индексы:

![](/PythonForAnalysts/Pictures/003_021.png)

И затем вызвать метод join у одного из датафреймов:

![](/PythonForAnalysts/Pictures/003_022.png)

Чтобы вытащить уникальные идентификаторы пользователей из индексов можно вызвать атрибут reset_index():

![](/PythonForAnalysts/Pictures/003_023.png)

[Содержание](#план-лекции-3)

<hr>

### Атрибут how

В методах merge и join есть атрибут how, который позволяет указать способ объединения таблиц. 

![](/PythonForAnalysts/Pictures/003_024.png)

-	left - остаются все объекты с левого датафрейма и ищутся совпадения из правого
-	right - остаются все объекты с правого датафрейма и ищутся совпадения из левого
-	inner - остаются объекты, которые есть и в левом датафрейме, и в правом
-	outer - остаются все объекты из двуз датафреймов

Возьмем небольшие два датафрейма для наглядности:

![](/PythonForAnalysts/Pictures/003_025.png)

А теперь объединим их с помощью merge с атрибутом how=’left’:

![](/PythonForAnalysts/Pictures/003_026.png)

Все строки с левого датафрейма сохранились, а вот с правого одна потерялась, потому что в левом датафрейме не было значения в col_1 равное 4, поэтому эта строка не появилась в результирующем датафрейме.

Теперь объединим их с помощью how=’right’:

![](/PythonForAnalysts/Pictures/003_027.png)

Остались все строки с правого датафрейма, а с левого две не оказались в результирующем датафрейме.

Следующий пример - атрибут how=’inner’:

![](/PythonForAnalysts/Pictures/003_028.png)

Осталось только их пересечение, а остальные строки не остались.

И заключительный пример с how=’outer’:

![](/PythonForAnalysts/Pictures/003_029.png)

А здесь вернулись все строки и с левого, и с правого датафрейма.

[Содержание](#план-лекции-3)

<hr>

## Методы группировки

[Содержание](#план-лекции-3)

<hr>

### groupby

В данном методе вначале происходит разбиение на группы, а затем можно сделать агрегацию по любой агрегирующей функции:

![](/PythonForAnalysts/Pictures/003_030.png)

Рассмотрим принцип работы на небольшом наборе данных:

![](/PythonForAnalysts/Pictures/003_031.png)

Сделаем группировку по идентификатору клиента, на выходе видим результат группировки:

![](/PythonForAnalysts/Pictures/003_032.png)

По атрибуту groups можем получить 3 группы наших клиентов и их индексы:

![](/PythonForAnalysts/Pictures/003_033.png)

И теперь можем делать любые агрегации, которые захотим, при этом их может быть несколько:

![](/PythonForAnalysts/Pictures/003_034.png)

![](/PythonForAnalysts/Pictures/003_035.png)

И посмотрим группировки на данных про клиентов банка, для этого сгруппируем их по признаку Geography и найдем средний возраст и минимальную заработную плату по странам:

![](/PythonForAnalysts/Pictures/003_036.png)


[Содержание](#план-лекции-3)

<hr>

### pivot_table

pivot_table (сводная таблица) - это мощный инструмент для обобщения и представления данных.

Параметры pivot_table():
-	index – столбец, который будет использован для строк
-	columns – столбец, который будет использован для столбцов
-	values – столбец обрабатываемых значений
-	aggfunc – функция, применяемая к values
-	fill_value – значение по умолчанию
-	margins – если True, то добавляется столбец All (Итого). По умолчанию: False
Вызовем pivot_table для игрушечного примера. 

Посчитаем сумму для столбца price для клиентов:

![](/PythonForAnalysts/Pictures/003_037.png)

При этом в атрибут aggfunc можно передавать словарь и тем самым мы получим точно такую же группировку, как и при использовании groupby:

![](/PythonForAnalysts/Pictures/003_038.png)

[Содержание](#план-лекции-3)

<hr>

### crosstab

Функция crosstab создает таблицу кросс-табуляции, которая по умолчанию может показать частоту, с которой появляются определенные группы данных.
Параметры crosstab():
-	index - значения для группировки по строкам
-	columns - значения для группировки по столбцам
-	values - агрегируемый столбец (или столбцы)
-	aggfunc - функция, которая будет применена к каждой группе значений values, сгруппированным по значениям index и columns. Значения этой функции и есть значения сводной таблицы
-	margins - добавляет результирующий столбец/строку
-	normalize: boolean, {'all', 'index', 'columns'} - нормировка всей таблицы (или только по строкам/столбцам).

По умолчанию crosstab подсчитывает количество значений в каждой выделенной категории, таким образом мы можем посчитать, сколько у нас есть людей разных полов в зависимости от страны. При этом обратите внимание, что в атрибуты нужно передавать всю колонку, а не только название признака:

![](/PythonForAnalysts/Pictures/003_039.png)

Можем добавить и колонку, которую надо агрегировать, теперь подсчитываем, какая средняя зарплата в зависимости от пола и страны человека:

![](/PythonForAnalysts/Pictures/003_040.png)

В функции crosstab есть нормировка по значениям:
-	атрибут normalize=’all’ - нормировка по всем значениям

![](/PythonForAnalysts/Pictures/003_041.png)

-	атрибут normalize=’index’ - нормировка по строкам

![](/PythonForAnalysts/Pictures/003_042.png)

-	атрибут normalize=’columns’ - нормировка по столбцам

![](/PythonForAnalysts/Pictures/003_043.png)

[Содержание](#план-лекции-3)

<hr>

## Встроенные визуализации

В связи с особенностями человеческого мозга в обрабатывании информации, проще использовать диаграммы или графики для визуализации больших объемов сложных данных, чем разбираться с таблицами или отчетами.	

Хорошая визуализация выделяет полезную информацию. 

Визуализация данных позволяет определить области, которые требуют внимания или улучшения, выяснить, какие характеристики влияют на поведение клиентов, а также понять и объяснить сложные процессы. 

Визуализация делает данные более запоминающимися.

Посмотрим на некоторые встроенные визуализации, которые доступны в самой библиотеке pandas, при этом разбираться в самих графиках и их интерпретациях будем на следующем занятии, а сейчас только посмотрим на возможности библиотеки pandas:
1.	hist() - гистограмма. С помощью неё можем изучить распределение возраста наших клиентов:

![](/PythonForAnalysts/Pictures/003_044.png)

2.	pie() - круговая диаграмма, с помощью неё поизучаем долю мужчин и долю женщин среди наших клиентов:

![](/PythonForAnalysts/Pictures/003_045.png)

3.	 scatter() - точечный график, он показывает взаимное распределение признаков. Изучим, а есть ли зависимость между возрастом клиента и его заработной платой:

![](/PythonForAnalysts/Pictures/003_046.png)

4.	 bar() - столбчатая диаграмма, показывает количество объектов в каждой категории. Посмотрим, сколько уже лет люди являются клиентами нашего банка:

![](/PythonForAnalysts/Pictures/003_047.png)

Это далеко не все графики, которые можно строить с помощью pandas, это лишь некоторые из них.

На следующей лекции будем знакомиться с визуальным анализом данных с помощью библиотек Matplotlib и Seaborn. Узнаем, какие бывают графики, как их отрисовывать и как их интерпретировать.

[Содержание](#план-лекции-3)

<hr>

## Рекомендуемая дополнительная литература или материалы
1.	[pandas.DataFrame.merge](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.merge.html)
2.	[pandas.DataFrame.plot](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.plot.html)

Используемая литература или материалы
1.	[Агрегации и группировки](https://pythonru.com/uroki/osnovy-pandas-2-agregacija-i-gruppirovka)

[Содержание](#план-лекции-3)

<hr>

## Работа на семинаре

![](/PythonForAnalysts/Pictures/003_048.png)

![](/PythonForAnalysts/Pictures/003_049.png)

![](/PythonForAnalysts/Pictures/003_050.png)

![](/PythonForAnalysts/Pictures/003_051.png)

![](/PythonForAnalysts/Pictures/003_052.png)

![](/PythonForAnalysts/Pictures/003_053.png)

![](/PythonForAnalysts/Pictures/003_054.png)