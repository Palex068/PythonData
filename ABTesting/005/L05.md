# Применение математической статистики для проверки гипотез в реальной жизни для популярных метрик

На этом уроке 
-	Поговорим о важности статистики для A/B тестов
-	Пройдемся по базовым понятиям статистики
-	Посмотрим, что такое Центральная предельная теорема и для чего она применяется в A/B тестировании
-	Разберем как оценивать по выборке в каких границах лежат реальные значения ваших метрик
-	Рассмотрим как минимизировать выкатку в продакшн неработающих решений и отклонение работающих

# Содержание

+ [Важность статистики в A/B тестах](#важность-статистики-в-ab-тестах)
+ [Базовые понятия статистики](#базовые-понятия-статистики)
+ [Законы распределения](#законы-распределения)
+ [Центральная предельная теорема](#центральная-предельная-теорема)
+ [Доверительные интервалы](#доверительные-интервалы)
+ [Ошибки первого и второго рода](#ошибки-первого-и-второго-рода)
+ [Концепция проверки статистических гипотез](#концепция-проверки-статистических-гипотез)
+ [Статистические критерии](#статистические-критерии)
+ [Алгоритм проверки гипотез](#алгоритм-проверки-гипотез)
+ [Обзор калькуляторов](#обзор-калькуляторов)
+ [Дополнительные материалы и используемые источники](#дополнительные-материалы)
+ [Практическое задание](#практическое-задание)
+ [Домашка](/ABTesting/005/HW05.ipynb)

[Содержание курса](/ABTesting/README.MD)

## Важность статистики в A/B тестах

![Важность статистики](/ABTesting/Pictures/005_001.jpg)

__Математическая статистика__  это раздел математики, в котором разрабатываются различные методы для описания и анализа наблюдений с цель использования для научных и практических выводов.

__Математическая статистика__ - фундамент A/B тестов, без правильного понимания которого резко возрастает риск принятия неверных решений в продукте. И в этом мы ни раз убедимся в рамках курса.

Как вы думаете возможно ли построить хороший дом без фундамента?<br>
Тут очевидно напрашивается единственно верный ответ.<br>
Аналогично, и в A/B тестах нельзя обойтись без базовых знаний по математической статистике, если вы хотите проводить в своем продукте качественные и полезные для бизнеса эксперименты .<br>

Зная основы математической статистики вы сможете:
+ Оценивать по выборке в каких границах лежат реальные значения ваших метрик
+ Сравнивать между собой выборки по различным параметрам
+ Понимать, где вы получили случайную разницу в метриках, а где нет
+ Рассчитывать длительность теста
+ Минимизировать выкатку в продакшн неработающих решений
+ Экономить команде время и деньги :)

### Что нужно, чтобы проводить A/B-тестирование?

+ Уметь рассчитывать размер выборки для теста
+ Понимать, что означает мощность теста
+ Понимать, насколько страшны ошибки I и II рода
+ Понимать, что означает p-value и доверительный интервал
+ Знать основные статистические критерии
+ Уметь корректно посчитать результаты теста


[Содержание](#содержание)

<hr>

## Базовые понятия статистики

![Базовые понятия](/ABTesting/Pictures/005_002.png)

Начнем с базовых понятий:

__Генеральная совокупность__ - совокупность всех объектов или наблюдений, относительно которых исследователь намерен делать выводы при решении конкретной задачи. В ее состав включаются все объекты, которые подлежат изучению.

__Выборка__ - часть генеральной совокупности с помощью определённой процедуры выбранных из генеральной совокупности для участия в исследовании. <br>
Могут возникнуть возникнуть вопросы: зачем же нужна выборка если есть генеральная совокупность? Почему сразу все не считать по ней?

В реальной жизни, у исследователей к сожалению, почти всегда нет доступа ко всем данным генеральной совокупности , это может быть долго, дорого , а иногда и физически невозможно.<br>
Чтобы переносить выводы с выборки на генеральную совокупность, выборка должна быть __репрезентативной__, отражать пропорции и особенности генеральной совокупности.

![Базовые понятия](/ABTesting/Pictures/005_003.png)

На репрезентативность сильно влияет метод отбора выборки(их существует довольно много). На практике часто используется [рандомизация](https://ru.wikipedia.org/wiki/Рандомизированное_контролируемое_испытание).

__Пример:__ <br>
Допустим в нашем исследовании - мы хотим знать средний рост мужчин в Москве живущих на данный момент .

Генеральная совокупность в данном случае - это все мужчины живущие мужчины в Москве сейчас (будет исчисляться миллионами).

Выборка - например, случайно отобранные 10 к мужчин из разных районов.

По этим мужчинам мы замерим рост и сможем оценить его истинное значение с определенной точностью, поговорим дальше как это сделать:)

Описываем выборку и ГС:<br>
В большинстве случаев как в бизнесе так и в научных исследованиях вы будете считать метрики и делать выводы по выборке, а не по всей генеральной совокупности. Вам нужно уметь описывать и то и другое, в этом вам помогут базовые понятия:

Желающие могут освежить знания ознакомившись со [статьей](https://medium.com/swlh/the-8-basic-statistics-concepts-for-data-science-7b865fca92b9) или посмотреть [видео](https://www.youtube.com/watch?v=4SEX9Bozktw).

__Случайная величина (ξ)__–  это математическое понятие, служащее для представления [случайных явлений](https://ru.wikipedia.org/wiki/Случайность), когда для них может быть определена их [вероятность](https://ru.wikipedia.org/wiki/Вероятность), то есть мера возможности наступления.

По сути это переменная со значениями. Для каждого значения есть своя вероятность исхода

Примеры случайных величин:
+ Оценка студента на экзамене
+ Цифра выпавшая при броске игральной кости
+ Время, которое провел юзер на странице за сеанс
+ Цена акции на бирже

Любая выборка представляет собой значения какой-либо случайной величины.

### Оценка параметров на основе выборки

Для точечного оценивания параметров случайной величины используются различные статистики. 

__Статистика__ — это любая измеримая функция от выборки. 

Пусть дана выборка Y = (y1, y2, . . , yi) значений случайной величины <br>
Как ее можно описать с помощью статистик?


__Математическое ожидание (μ, M)__ — это среднее арифметическое значение случайной величины.

$\bar{X} = \dfrac{1}{n} \cdot \displaystyle\sum_{i=1}^{n} x_i$

__Дисперсия (S2)__ – рассчитанное расстояние, на которое значения случайной величины находятся вокруг его математического ожидания

$\sigma_x^2 = \dfrac{1}{n-1} \cdot \displaystyle\sum_{i=1}^{n} (x_i - \bar{X})^2$

__Стандартное отклонение (SD)__— это квадратный корень от дисперсии

$\sigma_x =\sqrt{\dfrac{1}{n-1} \cdot \displaystyle\sum_{i=1}^{n} (x_i - \bar{X})^2}$

__Пример:__ Мы хотим узнать среднюю цену блюда в ресторане 1 и то насколько сильно в нем колеблются цены, для этого можем подсчитать базовые описательные статистики.

__Медиана__ это такое значение в выборке, что ровно половина из элементов выборки больше него либо равна, а другая половина меньше него либо равна. 

![Базовые понятия](/ABTesting/Pictures/005_025.PNG)

![Базовые понятия](/ABTesting/Pictures/005_004.png)

[Содержание](#содержание)

<hr>

## Законы распределения

__Законы распределения__<br>
Для описания случайных величин используются законы распределения с параметрами.

__Распределение вероятностей__ — это закон, описывающий область значений [случайной величины](https://ru.wikipedia.org/wiki/Случайная_величина) и соответствующие вероятности появления этих значений.

На рисунке ниже визуализированы различные законы распределения:

![Базовые понятия](/ABTesting/Pictures/005_005.png)

__Нормальное распределение:__

Нормальное распределение самый частый вид, который используется в статистике. Закон распределения задается по формуле: 

![Базовые понятия](/ABTesting/Pictures/005_006.png)

$f(x) = \dfrac {1}{\sigma \cdot \sqrt{2 \pi}} \cdot exp \Big(- \dfrac{(x - \mu)^2}{2 \sigma^2}\Big)$

![Базовые понятия](/ABTesting/Pictures/005_007.png)

Где, 𝞵 - математическое ожидание  и 𝞼 - стандартным отклонением. Эти параметры моделируют, как будет выглядеть распределение. Большая часть тестов при проверке гипотез требует в качестве условий корректности работы-  нормальность распределения или принадлежность к какому-либо закону распределения.

![Базовые понятия](/ABTesting/Pictures/005_026.PNG)

![Базовые понятия](/ABTesting/Pictures/005_027.PNG)

![Базовые понятия](/ABTesting/Pictures/005_028.PNG)

![Базовые понятия](/ABTesting/Pictures/005_029.PNG)

[Содержание](#содержание)

<hr>

## Центральная предельная теорема

__Центральная предельная теорема__

Как можно судить о свойствах генеральной совокупности по выборке?

[ЦПТ](https://www.marketing.spb.ru/lib-around/stat/Naked_Statistics.htm) говорит, что если мы возьмем достаточно большую выборку из независимых, одинаково распределенных случайных величин( [i.i.d](https://ru.wikipedia.org/wiki/Независимые_одинаково_распределённые_случайные_величины)) из генеральной совокупности , то среднее значение будет [нормально распределено](https://ru.wikipedia.org/wiki/Нормальное_распределение) с μ(мат ожидание) и SD(стандартное отклонение) .

Причем мы можем посчитать оценить параметры μ и SD по нашей выборке.

[Визуализация ЦПТ](https://seeing-theory.brown.edu/probability-distributions/index.html)<br>
Берем и многократно извлекаем выборки определенного размера и считаем по ним среднее. Распределение средних при соблюдении предпосылок выше будет нормально распределенным и мы сможем оценивать истинное значение в ГС.

![Базовые понятия](/ABTesting/Pictures/005_008.png)

(промежуточный скрин из визуализатора показывает что мы постепенно будем приближаться к нормальному распределению при многократном извлечении)
Что нам позволяет делать ЦПТ ?
ЦПТ дает возможность строить доверительные интервалы и проверять статистические гипотезы. Поговорим об этом ниже. При желании вы можете прочитать  [хороший разбор ЦПТ тут](https://www.marketing.spb.ru/lib-around/stat/Naked_Statistics.htm).

![Базовые понятия](/ABTesting/Pictures/005_030.PNG)

![Базовые понятия](/ABTesting/Pictures/005_031.PNG)

[Содержание](#содержание)

<hr>

## Доверительные интервалы

![Базовые понятия](/ABTesting/Pictures/005_032.PNG)

__Доверительные интервалы__<br>
Допустим у вас e-commerce магазин и вы хотите посчитать какое истинное значение конверсии(по всей ГС) из добавления товаров в корзину в покупку для вашего продукта .

К сожалению, истинное значение конверсии вы не знаете - но зато у вас есть доступ к данным ваших систем аналитики и вы сможете посчитать выборочное значение и по нему оценить в каком диапазоне может лежать истинное значение конверсии. В этом нам поможет доверительный интервал, который мы можем применять благодаря ЦПТ.

__Доверительный интервал для долей__<br>
Что это такое ? Это способ оценки метрики, используя который, мы получим диапазон значений [x,y] , внутри которого будет лежать истинное значение метрики ГС в 95% случаев.

(Если провести очень большое количество независимых экспериментов с аналогичным построением доверительного интервала, то в 95% экспериментов доверительный интервал будет содержать оцениваемый параметр ген совокупности.

В оставшихся 5% экспериментов доверительный интервал не будет содержать параметр ген совокупности.)

![Базовые понятия](/ABTesting/Pictures/005_009.png)

(Мы можем регулировать точность и выбирать 99% , 90% и другие диапазоны.)

![Базовые понятия](/ABTesting/Pictures/005_033.PNG)

Для метрик долей*(ретеншн, конверсия и тп) используется формула

![Базовые понятия](/ABTesting/Pictures/005_010.png)

*Типы метрик которые бывают в экспериментах:
1. Доли - (ретеншн, конверсии) [0,1,0,0,0,1]
2. Непрерывные - таймспент в сек / деньги
3. Отношения - (клики на сессию , поездки на юзера))

Вы можете рассчитать доверительный интервал на калькуляторе:

[Ссылка на калькулятор](https://www.rotmistrov.com/intrvl)

Пример расчета доверительного интервала для конверсии:

Допустим по выборке 1000 юзеров мы посчитали конверсию из добавления товаров в корзину в покупку для нашего e-commerce магазина , конверсия равнялась 10%.

Мы хотим с уровнем доверия 95% оценить истинное значение конверсии. Для этого используем формулу:

![Базовые понятия](/ABTesting/Pictures/005_010.png)

$0.10 +- 1.96 * (0.10 * (1-0.10) /1000) ^ 1/2$

Доверительный интервал будет следующий:

$[8.14\% , 11.86\% ]$

Давайте попробуем проинтерпретировать полученный результат:

В нашем e-commerce магазина истинная конверсия лежит в диапазоне 

$[8.14\% , 11.86\% ]$ с $95\%$ уровнем доверия .

Если бы мы много раз оценивали по выборкам конверсию - ее истинное значение лежало бы в 95% cлучаев в границах доверительного интервала в каждом из расчетов. При желании чуть глубже погрузиться вы можете посмотреть  [видео 1](https://www.youtube.com/watch?v=MstzroncW28) + [видео 2](https://www.youtube.com/watch?v=GoK7sod8dhU)

Как вы могли заметить по формуле доверительного интервала: Чем больше выборка, тем точнее оценка.


[Содержание](#содержание)

<hr>

## Ошибки первого и второго рода

![Базовые понятия](/ABTesting/Pictures/005_034.PNG)

Рассмотрим базовые понятия:

__Нулевая гипотеза__ – принимаемое предположение о том, что не существует связи между наблюдениями в двух (или более) событиях (выборках, феноменах, совокупностях). Гипотезу отвергают, если данные показывают разницу между выборками.

__True Positive__ = говорим истина, когда по факту истина (факт) <br>
__True Negative__ = говорим не истина, когда по факту тоже не истина (факт)

__False Positive__ (ошибка I рода) = говорим истина, когда по факту не истина. <br>
Отклонение верной нулевой гипотезы. Риск совершить такую ошибку равен выбранному уровню статистической значимости (например, α=0.05) (ошиблись)

__False Negative__ (ошибка II рода) = говорим не истина, когда по факту истина (ошиблись). <br>
Принятие неверной нулевой гипотезы. Вероятность ошибочно сохранить неверную нулевую гипотезу обозначают буквой β (например, 0.2).

__Статистический критерий(тест)__ — это математическое правило, которое помогает нам понять, отвергнута или нет наша гипотеза.  Мы поговорим о них подробно на следующем занятии.

__Мощность критерия/теста__ - это вероятность, что тест правильно засечёт эффект там, где он и правда есть. (т.е. 1-β) <br>
Допустим мы сформулировали нулевую гипотезу для эксперимента(поговорим о них подробнее на следующих занятиях). У нас могут быть следующие исходы:

![Базовые понятия](/ABTesting/Pictures/005_011.png)

__Рассмотрим пример:__

Однажды воскресным вечером через пару дней после веселых посиделок в баре вы замечаете что у вас пропало обоняние и появилась легкая усталость. <br>
Вы пошли и сдали тест на COVID и получили положительный результат. <br>
Но не спешите грустить и лучше по возможности сдайте его повторно:

В реальности могут быть следующие исходы :
+ Вы реально больны и тест показал что вы больны __True positive__
+ Вы реально не больны и тест показал что вы больны __False positive__
+ Вы реально не больны и тест показал что вы не больны __True negative__
+ Вы реально больны и тест показал что вы не больны __False negative__

У всех тестов разное качество что может влиять на False Positive и False negative. Поэтому лучше перепроверяться еще один наглядный пример:

![Базовые понятия](/ABTesting/Pictures/005_012.png)

Мы в продуктах не хотим принимать ложноотрицательные(отклонять крутые гипотезы) и ложноположительные(раскатывать плохие гипотезы) решения и хотим минимизировать ошибку первого и второго рода .Выбираем alpha и ищем самый мощный критерий среди корректных.

Мощность и точность зависят от размера выборки - чем большую мощность и точность мы хотим - тем больше выборка нам нужна - поговорим об этом в следующей главе. Вам сейчас важно понять суть различных ошибок - поскольку в дальнейшем они будут использоваться регулярно.

![Базовые понятия](/ABTesting/Pictures/005_035.PNG)

[Содержание](#содержание)

<hr>

## Концепция проверки статистических гипотез

![Базовые понятия](/ABTesting/Pictures/005_036.PNG)

![Базовые понятия](/ABTesting/Pictures/005_037.PNG)

![Базовые понятия](/ABTesting/Pictures/005_038.PNG)

![Базовые понятия](/ABTesting/Pictures/005_039.PNG)

![Базовые понятия](/ABTesting/Pictures/005_040.PNG)

В этой главе поговорим о том, как устроен процесс проверки статистических гипотез и какие нюансы существуют .

Начнем с определения статистической гипотезы.

__Статистическая гипотеза__ - это выдвигаемое предположение о свойствах и характеристиках генеральной совокупности(ей).

После выдвижения гипотезы собираются реальные данные выборок(выборки) и к ним применяются статистические методы(критерии) например t test или z test, о которых детальнее мы поговорим позже.

После применения критериев мы либо отвергаем, либо не отвергаем гипотезу. Эта гипотеза называется нулевой и мы дадим ей подробное определение ниже.

__Примеры гипотез:__

Среднее время звонка для всех наших клиентов равно 3 минуты<br>
Уровень брака в текущей партии продукта равен 1%<br>
Retention 5 дня в контрольной группе не отличается от Retention 5 дня в тестовой группе.

__Важно!__: Корректно говорить не отвергаем нулевую гипотезу, а не принимаем.

Проверка гипотез в статистике строится по методу доказательства от противного. Сначала выдвигают нулевую гипотезу и предполагают что она верна. <br>
Ее придерживаются пока наблюдаемые данные на докажут обратное.

__Нулевая гипотеза__ – принимаемое предположение о том, что не существует связи между наблюдениями в двух (или более) событиях (выборках, феноменах, совокупностях). <br>
Гипотезу отвергают, если данные показывают разницу между выборками.

Нулевой гипотезе сопутствует альтернативная гипотеза - принимаемая в случае отвержения нулевой гипотезы.

Если предположение противоречит наблюдаемым данным, то гипотезу отклоняют, как ложную в пользу альтернативной, если не противоречит, то говорят что оснований отвергнуть нулевую гипотезу нет.

Сила противоречия зависит от того, того насколько далеко выборочная статистика(например для выб.среднего) отклоняется от гипотезы.

Благодаря [ЦПТ](https://www.marketing.spb.ru/lib-around/stat/Naked_Statistics.htm), которая рассматривалась на предыдущем занятии знаем что выборочные средние при соблюдении определенных предпосылок имеют нормальное распределение.

Чтобы погрузиться тему чуть глубже /освежить знания можно почитать:

[статья 1](https://towardsdatascience.com/statistics-is-the-grammar-of-data-science-part-2-8be5685065b5) + [статья 2](https://www.marketing.spb.ru/lib-around/stat/Naked_Statistics.htm) + [видео 1](https://www.youtube.com/watch?v=2tuBREK_mgE) или [видео 2](https://www.youtube.com/watch?v=9jL5JifQ1WI)

![Базовые понятия](/ABTesting/Pictures/005_013.png)

Можно рассматривать площадь под кривой в определенном диапазоне как вероятность получить тот или иной диапазон значений.
Поизучать по теме статья про [z score № 1](https://medium.com/@ashishtuteja87/what-is-z-score-and-p-value-b7daf7db008f) и [статья № 2](https://ru.wikihow.com/вычислить-Z-оценку)

На графике выше можно заметить что существуют область принятия и область отклонения гипотезы.

__Областью принятия гипотезы__ называют совокупность значений статистики критерия, при которых гипотезу H0(нулевую) принимают.

__Областью отклонения гипотезы(критической областью)__ - называется область значений статистики критерия, при которых отвергается H0(нулевую).

__Критические значения__ - это граница критической области, они зависят от выбранного alpha. Вид критической области определяется видом альтернативной.<br>
Мы смотрим куда у нас попадает выборочное значение. Если рассчитанное значение окажется в зоне близкой к центру(в области принятия гипотезы), то оно не противоречит гипотезе(могли быть просто небольшие колебания в силу случайности).<br>
Но если оно окажется далеко от центра за пределами критических значений(слева или справа) - это значит что вероятность получить такое или еще более высокое отклонение крайне мало и гипотеза скорее всего ложная.

Гипотезы могут быть __односторонними__ и __двухсторонними__ (см.график ниже). На практике почти всегда используют двухсторонние тк мы почти никогда не знаем заранее перед запуском теста в какую сторону отклонится метрика в тестовой группе. А после получения данных менять двухсторонний на односторонний критерий некорректно - таким образом мы подгоняем теорию под наши данные.

![Базовые понятия](/ABTesting/Pictures/005_014.jpg)

Для углубленного изучения при желании можно почитать [лекции ВШЭ](http://math-info.hse.ru/f/2017-18/ps-ms/hypo-test.pdf) и [статью](статью).

В современном мире используется понятие:

__[p-value](https://medium.com/@ashishtuteja87/what-is-z-score-and-p-value-b7daf7db008f)__ – вероятность при справедливости нулевой гипотезы получить наблюдаемое или еще большее отклонение оценки статистики(например среднего) по сравнению с предполагаемым в гипотезе.

![Базовые понятия](/ABTesting/Pictures/005_015.jpg)

Многие некорректно интерпретируют p-value. 

Основная проблема - для многих людей это не интуитивная сущность и возникают проблемы с интерпретацией. Я предлагаю вам по желанию ознакомиться с парой интересных статей о нем, чтобы не совершать ошибок при интерпретации данного понятия .

[Статья на русском на хабре](https://habr.com/ru/company/stepic/blog/250527/) и на [английском](http://www.perfendo.org/docs/BayesProbability/twelvePvaluemisconceptions.pdf).

Если p-value < alpha (false poistive), то нулевая гипотеза отвергается в пользу альтернативной!.

__Пример:__ проверяем гипотезу о равенстве конверсии в покупку магазина e-commerce В одной группе CR1 =1 % в другой СR2 = 1,01%.

Выдвигаем нулевую гипотезу что между CR1 и CR2 нет разницы, это двухсторонняя гипотеза, alpha(false positive) возьмем равную 5%.

Допустим , применив критерий мы вычислили p-value =0,7% .

Сравнив p-value и alpha : 0,7 > 0,05 - значит нулевая гипотеза не отвергается.(исторически сложился бенчмарк 5%, но также допустимы и другие отсечки например 1%,10% и другие в зависимости от объема выборки в продукте и готовности получать false positive ошибки.)

К p-value мы еще вернемся в следующих главах. В соседних главах рассмотрим статистические критерии , алгоритм принятия решений и идею статистического вывода по данным.

[Содержание](#содержание)

<hr>

## Статистические критерии

![Базовые понятия](/ABTesting/Pictures/005_041.PNG)

![Базовые понятия](/ABTesting/Pictures/005_042.PNG)

![Базовые понятия](/ABTesting/Pictures/005_043.PNG)

Чаще всего в A/B тестах проверяют гипотезу о равенстве двух показателей(средних) - используя для этого статистические критерии.

__Статистический критерий__ — математическое правило, в соответствии с которым отвергается либо не отвергается та или иная статистическая гипотеза с заданным уровнем значимости.

Для того, чтобы проверить гипотезу о равенстве показателей, применяется два типа критериев оценки: _параметрические_ и непараме_трические.

Если просто описывать основную суть их различия - то можно сказать что:

__Параметрическими__ называются критерии, в которых мы можем сделать предположение о распределении , относящееся к какой-то выборке. В большинстве случаев в качестве распределения используется нормальное.(t тест)

__Непараметрические__ не используют предположения о распределении, а оперируют рангами и частотами.(U-критерий Манна — Уитни )

У каждого критерия есть предпосылки - и можно использовать таблицу ниже для выбора подходящего критерия.

![Базовые понятия](/ABTesting/Pictures/005_016.png)

### Выбор критерия light version

+ __Конверсии__ ([Хи-квадрат на однородность](https://www.evanmiller.org/ab-testing/chi-squared.html#!14/100;20/100@95) распределения в двух ген совокупностях или [Z критерий долей](https://abtestguide.com/calc/))

+ __Средние__ если нормальное распределение то [t критерий](https://www.evanmiller.org/ab-testing/t-test.html) если не нормальное распределение то [критерий Манна-Уитни](https://ccb-compute2.cs.uni-saarland.de/wtest/)

![Базовые понятия](/ABTesting/Pictures/005_044.PNG)

Необязательно знать все критерии - на практике чаще всего используется лишь [их часть](https://lit-review.ru/biostatistika/vybor-statisticheskogo-kriteriya/).

Часто используются [t-test Уэлча](https://ru.wikipedia.org/wiki/T-критерий_Уэлча) для сравнения средних , z - критерий , для сравнения метрик долей(конверсии/ретеншн) , критерий Хи-квадрат тоже подойдет для долей + Критерий Манна Уитни для сравнения ненормально распределенных величин.

Рассмотрим z - критерий для метрик долей как с помощью него проверять гипотезы для конверсий /ретеншн итд используя p-value и доверительный интервал.

__Критерии долей__ — это критерии, которые работают с [распределениями Бернулли](https://ru.wikipedia.org/wiki/Распределение_Бернулли).

Они принимают на вход выборки из нулей и единиц и проверяют гипотезы о вероятности появления единицы в выборке

![Базовые понятия](/ABTesting/Pictures/005_017.png)

Гипотезы можно проверять с помощью доверительного интервала или p-value.

Допустим мы запустили эксперимент направленный на улучшение конверсии на каком-нибудь участке продукта , получили результаты конверсий в обеих группах и хотим понять эта разница получена не случайно, а действительно существует закономерность.

![Базовые понятия](/ABTesting/Pictures/005_018.jpg)

У каждой из метрик в двух выборок есть:
+ сигнал(разница средних) и
+ шум (дисперсия). 

Мы хотим понять несмотря на наличие шума а есть ли действительная разница между средними ? <br>
В этом нам помогают статистические критерии.

В случае с критериями долей мы можем использовать следующий принцип:
Пусть:
+ $p̂_1$ и $p̂_2$ посчитанные в A/Б-тесте конверсии, в контроле $p̂_1$ , а в тесте $p̂_2$.
+ n1 и n2 — количество элементов в каждой

1. Используя доверительный интервал: выберем уровень значимости alpha = 5% <br>
Тогда 95% доверительный интервал для их разницы будет считаться следующим образом:

![Базовые понятия](/ABTesting/Pictures/005_019.png)

Мы получим диапазон значений [х;y]

Если 0 входит в интервал значит на основе собранных данных статистически значимой разницы между группами не обнаружено.


Если не входит, то между группами есть стат.значимая разница.

2. __Альтернатива__ - можем также по нашим данным посчитать p-value:

Выберем уровень значимости alpha = 5%

Посчитаем p-value на полученных в эксперименте данных.

Помним про нулевую гипотезу:(Разницы между средними в двух группах нет.)

Если p-value > 5% значит на основе собранных данных статистически значимой разницы между группами не обнаружено.

Если p-value < 5% , то между группами есть стат.значимая разница

__Рассмотрим пример:__

Допустим мы запустили эксперимент направленный на улучшение конверсии на одном из кусков сайта:

![Базовые понятия](/ABTesting/Pictures/005_020.png)

Хотим понять есть ли стат.значимая разница между группами с достоверностью 95%:

Пусть $p̂_1$ и $p̂_2$ посчитанные в A/Б-тесте конверсии, в контроле $p̂_1 = 8,29\%$ , а в тесте $p̂_2 = 7,41\%$.

$n1$ и $n2$ — количество посетителей в каждой из них.

Посчитаем доверительный интервал по формуле:

![Базовые понятия](/ABTesting/Pictures/005_021.png)

0.0742-0.0829 ± 1.96 * ( 0.0742 × (1 − 0.0742) ÷ 2400 + 0.0829 × (1 − 0.0829) ÷ 2400 ) ^1/2 = [-2.392% ; 0.652%]

0 входит в интервал - значит на основе собранных данных статистически значимой разницы между группами не обнаружено.

Также можно было бы посчитать p-value воспользовавшись например калькуляторами:

[Калькулятор 1](https://abtestguide.com/calc/)
[Калькулятор 2](https://www.surveymonkey.ru/mp/ab-testing-significance-calculator/)

p value = 0.1299 > 0.05 - на основе собранных данных статистически значимой разницы между группами не обнаружено.

Похожий принцип принятия решений действует и для других критериев.

[Содержание](#содержание)

<hr>

## Алгоритм проверки гипотез

![Базовые понятия](/ABTesting/Pictures/005_045.PNG)

Давайте рассмотрим алгоритм проверки гипотез, который можно использовать при проверке гипотез.
1.	Выбираем метрику и формулируем нулевую и альтернативную гипотезы
2.	Выбираем параметр alpha (например 5%) равный вероятности допустить ошибку первого рода
3.	Выбираем критерий, подходящий под наши условия
4.	Считаем p - value и(или) доверительный интервал и делаем вывод:
Если p-value < alpha - разница между группами стат.значима . Либо если доверительный интервал для разницы не включает 0.
5.	Даем (рекомендации лицам принимающим решения /принимаем решение ) выкатывать или не выкатывать новое изменение - если ключевая метрика в группе с новой фичей стат значимо лучше чем в контроле а дополнительные метрики не упали- можно раскатывать , помня про ошибку первого рода.

Критерии принятия решений определяются заранее на этапе планирования эксперимента.

[Содержание](#содержание)

<hr>

## Обзор калькуляторов

Калькуляторы, которые вы можете использовать:
1.	https://www.evanmiller.org/ab-testing/t-test.html
2.	https://abtestguide.com/calc/
3.  https://www.surveymonkey.ru/mp/ab-testing-significance-calculator/

![Базовые понятия](/ABTesting/Pictures/005_022.png)

![Базовые понятия](/ABTesting/Pictures/005_023.png)

### [t критерий Стьюдента](https://www.evanmiller.org/ab-testing/t-test.html)

![Базовые понятия](/ABTesting/Pictures/005_046.PNG)

### [U критерий Манна-Уитни](https://ccb-compute2.cs.uni-saarland.de/wtest/)

![Базовые понятия](/ABTesting/Pictures/005_047.PNG)

## [Критерий Хи-квадрат на однородность распределений](https://www.evanmiller.org/ab-testing/chi-squared.html#!14/100;20/100@95)

![Базовые понятия](/ABTesting/Pictures/005_048.PNG)

## [Z test для долей](https://abtestguide.com/calc/)

![Базовые понятия](/ABTesting/Pictures/005_049.PNG)

[Содержание](#содержание)

<hr>

## Дополнительные материалы

1.	[Видео про описательную статистику](https://www.youtube.com/watch?v=4SEX9Bozktw)
2.	[Базовые концепты статистики](https://medium.com/nuances-of-programming/8-базовых-понятий-статистики-для-науки-о-данных-14a1ed2e31ae)
3.	[Хорошее описание ЦПТ](https://www.marketing.spb.ru/lib-around/stat/Naked_Statistics.htm)
4.	[Про доверительные интервалы от Демешева](https://www.youtube.com/watch?v=GoK7sod8dhU)
5.	[Про доверительные интервалы от Кирилла Мильчакова](https://www.youtube.com/watch?v=MstzroncW28)
6.	[Про MDE и ошибки 1 и 2 типа - вводная статья](https://medium.com/@PAPP/significant-power-d9c3bc3dd3c)
7.	[Про MDE посложнее](https://rpubs.com/hedbergec/sirc)
8.	[Книга Голая статистика](https://www.livelib.ru/book/1001518877-golaya-statistika-samaya-interesnaya-kniga-o-samoj-skuchnoj-nauke-charlz-uilan)
9.	[Книга статистика и котики](https://www.livelib.ru/book/1002721779-statistika-i-kotiki-vladimir-savelev)
10.	[Книга Statistics in Nutshell](https://www.oreilly.com/library/view/statistics-in-a/9781449361129/)


[Содержание](#содержание)

<hr>


## Практическое задание

[Содержание](#содержание)

<hr>

[Содержание курса](/ABTesting/README.MD)